<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Instructor Dashboard</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <div class="navbar">logo, status, navigation</div>

  <main>
    <h2>Instructor name</h2>

    <div class="student-info">
      <table>
        <thead>
          <tr>
            <th>course name</th>
            <th>exam period</th>
            <th>student</th>
            <th>action</th>
          </tr>
        </thead>
        <tbody id="requests-body"></tbody>
      </table>
    </div>

    <div class="reply-form">
      <h3>REPLY TO GRADE REVIEW REQUEST</h3>
      <p id="reply-title"><strong>course</strong> | <strong>period</strong> | <strong>student</strong></p>

      <!-- ΝΕΟ: Μήνυμα φοιτητή -->
      <div class="form-group">
        <label for="student-request">Student's Request Message</label>
        <div id="student-request" style="background: #f0f0f0; padding: 1rem; border-radius: 8px; white-space: pre-line;"></div>
      </div>

      <div class="form-group">
        <label for="action">Action</label>
        <select id="action">
          <option>Total accept</option>
          <option>Reject</option>
        </select>
      </div>

      <div class="form-group">
        <label for="message">Instructor's message</label>
        <textarea id="message" rows="4"></textarea>
      </div>

      <button onclick="submitReply()">Υποβολή Απάντησης</button>
    </div>
  </main>

  <script>
    const path = window.location.pathname;
    const parts = path.split('/');
    const requestId = parts[parts.length - 1];
    let instructorId = null;

    fetch(`/GradesReviewRequest/ReviewsRespond/${requestId}/data`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('reply-title').innerHTML =
          `<strong>${data.course_name}</strong> | <strong>${data.exam_period}</strong> | <strong>${data.student}</strong>`;
        instructorId = data.instructor_id;

        // Εμφάνιση μηνύματος φοιτητή
        document.getElementById('student-request').textContent =
          data.request_message || '(No message provided)';

        return fetch(`/GradesReviewRequest/ReviewsPending/data/${instructorId}`);
      })
      .then(res => res.json())
      .then(requests => {
        const tbody = document.getElementById('requests-body');
        tbody.innerHTML = requests.length === 0
          ? '<tr><td colspan="4">No pending requests.</td></tr>'
          : requests.map(req => `
              <tr>
                <td>${req.course_name}</td>
                <td>${req.exam_period}</td>
                <td>${req.student}</td>
                <td><button onclick="location.href='/GradesReviewRequest/ReviewsRespond/${req.request_id}'">Reply</button></td>
              </tr>
            `).join('');
      })
      .catch(err => {
        console.error('[ERROR]', err);
        document.getElementById('requests-body').innerHTML = '<tr><td colspan="4">Σφάλμα φόρτωσης.</td></tr>';
      });

    function submitReply() {
      const message = document.getElementById('message').value;
      const action = document.getElementById('action').value;
      const fullMessage = `${action}: ${message}`;

      if (!message.trim()) {
        alert('Το μήνυμα απάντησης δεν μπορεί να είναι κενό.');
        return;
      }

      fetch(`/GradesReviewRequest/ReviewsRespond/${requestId}/reply`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ respond_message: fullMessage }),
      })
        .then(res => res.json())
        .then(data => {
          alert(data.message || 'Η απάντηση υποβλήθηκε.');
          window.location.reload();
        })
        .catch(err => {
          alert('Σφάλμα κατά την υποβολή: ' + err.message);
        });
    }
  </script>
</body>
</html>
